<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cart</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #userInfo { float: left; }
    #logout { float: right; cursor: pointer; color: blue; text-decoration: underline; }
    .cart-item { border-bottom: 1px solid #ccc; padding: 10px 0; display: flex; align-items: center; }
    .cart-item img { width: 80px; height: 80px; object-fit: cover; margin-right: 20px; }
    .cart-item-details { flex-grow: 1; }
    .cart-item-quantity { font-weight: bold; }
    #sendBtn { margin-top: 20px; padding: 10px 20px; font-size: 16px; cursor: pointer; }
    .clearfix::after { content: ""; clear: both; display: table; }
  </style>
</head>
<body>

  <div class="clearfix">
    <div id="userInfo"></div>
    <div id="logout" onclick="logout()">Logout</div>
  </div>

  <h1>Your Cart</h1>
  <div id="cartItems"></div>

  <button id="sendBtn" onclick="sendCartToSFMC()">Send to SFMC</button>

  <!-- Hidden form for POSTing to SFMC CloudPage -->
  <form id="cartForm" action="https://mcbpcpxtk6qzkpnzk1spgzn07rh0.pub.sfmc-content.com/dyp1jbqcr2l" method="POST" target="_blank" style="display:none;">
    <input type="hidden" name="email" id="emailInput" />
    <input type="hidden" name="name" id="nameInput" />
    <input type="hidden" name="loginTime" id="loginTimeInput" />
    <input type="hidden" name="cartItems" id="cartItemsInput" />
  </form>

  <script>
    // Sample product images mapped by item id
    const productImages = {
      p1: "https://via.placeholder.com/80?text=Laptop",
      p2: "https://via.placeholder.com/80?text=Phone",
      p3: "https://via.placeholder.com/80?text=Headphones"
    };

    const email = localStorage.getItem("user_email");
    const name = localStorage.getItem("user_name");
    const loginTime = localStorage.getItem("login_time");

    if (!email) {
      alert("Please login first");
      window.location.href = "login.html";
    }

    // Show user info left and logout right
    const userInfoDiv = document.getElementById("userInfo");
    userInfoDiv.innerHTML = `
      <strong>User:</strong> ${name || "Unknown"} <br/>
      <strong>Email:</strong> ${email} <br/>
      <strong>Login Time:</strong> ${loginTime || "N/A"}
    `;

    function logout() {
      localStorage.clear();
      window.location.href = "login.html";
    }

    // Load cart from localStorage
    const cartKey = `cart_items_${email}`;
    const cart = JSON.parse(localStorage.getItem(cartKey)) || [];

    const cartItemsDiv = document.getElementById("cartItems");

    if (cart.length === 0) {
      cartItemsDiv.innerHTML = "<p>Your cart is empty.</p>";
    } else {
      cart.forEach(item => {
        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <img src="${productImages[item.item] || 'https://via.placeholder.com/80'}" alt="${item.name}" />
          <div class="cart-item-details">
            <strong>${item.name}</strong><br/>
            Price: $${item.price.toFixed(2)}<br/>
            Quantity: <span class="cart-item-quantity">${item.quantity}</span>
          </div>
        `;
        cartItemsDiv.appendChild(div);
      });
    }

    // Submit cart data to SFMC CloudPage using hidden form POST
    function sendCartToSFMC() {
      if (cart.length === 0) {
        alert("Your cart is empty. Add items first.");
        return;
      }

      document.getElementById("emailInput").value = email;
      document.getElementById("nameInput").value = name;
      document.getElementById("loginTimeInput").value = loginTime;
      document.getElementById("cartItemsInput").value = JSON.stringify(cart);

      document.getElementById("cartForm").submit();

      alert("Sending cart data to SFMC...");
    }
  </script>

</body>
</html>
